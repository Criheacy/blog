---
slug: drying-clothes-and-memory-management
title: 晾衣服与内存管理
authors:
  name: Criheacy
  title: Owner of this Blog
  url: https://github.com/Criheacy
  image_url: https://github.com/Criheacy.png
tags: [sharing]
---

## 晾衣杆

设想这样一个场景：阳光明媚的一天，你拿着刚洗好的衣服晒到阳台上的衣架上。

房间的阳台空空荡荡，只有一根高高的晾衣杆撑在两边的墙壁上。



【图】



你把每一件衣服叠平整，搭在晾衣杆上。为了保证每一件衣服都能接触到阳光，衣服应该在杆子上一字排开，彼此之间不能叠在一起，要不然被压在底下的衣服会干得很慢；也就是说，每件衣服占据了晾衣杆的一小段。



【图】



在程序世界中，一件件衣服就是一个个变量，这里的晾衣杆被称为**「栈内存」**。为什么叫栈内存呢？接着往下看。



## 衣架

有一天，你一次性洗了太多的衣服，晾衣杆长度有限，排不开这么多衣服了。



【图】



前面说过，衣服是不能叠起来的，要不然晒不干。怎么办呢？一番思考之后，你发现把一件衣服整个平摊开搭在晾衣杆上太占地方了，不如搞几个衣架来，每个衣架只需要晾衣杆上的一点点空间就可以晒开一整件衣服了。

说干就干，你找来了几个衣架，用衣架夹住衣服，再勾到晾衣杆上。



【图】



这看似是平平无奇的一个过程。但是仔细思考一下，原本晾衣杆上的空间是不够的，衣架本身也是一个占一定空间的实体，为什么用上了衣架之后反而就能晒开所有衣服了呢？

你会发现，衣架不仅用上了晾衣杆，还利用了晾衣杆下方的一部分空间，衣架只是把「晾衣杆」和下方的空间连起来（要不然衣服也不会凭空悬浮在空气中）。



【图】



这真是一个天才的想法（虽然家家户户每天都在用）！我们把这一块晾衣杆下方的空间叫做**「堆内存」**，把衣架叫做**「指针」**。指针本身占据「栈内存」上的一段空间，用来连接到「堆内存」。



## 脱落

衣架大大提升了你的空间利用效率，现在你可以一次性晒上很多衣服。

有一天傍晚，你收衣架上的衣服时，刚松开衣架的夹子，结果一没留神没来得及抓住衣服，衣服直接掉在了地上。刚洗好的衣服弄脏了！好在晾衣杆处在室内，你赶紧从阳台地上捡起来拍拍灰尘；要是那种室外的晾衣杆，一没抓住衣服就直接掉到楼下去了，还不知道会飘到哪去呢！



【图】

【图】



这种事故起因是衣架的夹子松开了衣服，同时又没有人来及时抓住衣服，于是衣服就掉到了晾衣杆不可触及的区域。我们把这种事故叫做**「内存泄漏」**。

不过一般情况下，晾衣杆都是处在室内的，就算发生了「内存泄漏」，大不了我们也能从阳台的地上再把衣服捡起来。在这里，阳台被称作**「操作系统」**。操作系统可以提供一层外部的防护，能够回收晾衣架泄漏的内存。



## 竹筐

晒的衣服多了，这种衣服掉到地上的事故难免发生。诚然衣服不会掉到楼下，但是掉到地面上衣服还是会脏啊！每次都从地面上捡起来终究不是一个好办法。

经过好几次事故之后，你想到一个办法：准备收衣服的时候，先把一个大竹筐放在晾衣杆的正下方，这样就算衣服从衣架上脱落下来，也会掉进竹筐里。经过几次试验，你逐渐找准了竹筐的位置，确保它能准确接住每一件衣服。



【图】



几天过去了，你已经完全掌握了放置竹筐的位置，闭着眼睛都能把竹筐放好。你甚至不再需要每次抓住衣服，只需要松开衣架的夹子，任凭衣服自己落到竹筐里，最后把竹筐从阳台抱回去就能收回满满一筐晒干的衣服了。

竹筐在程序世界中叫做**「垃圾回收器（Garbage Collector, GC）」**。以 Java 为代表的一部分语言就采用这种机制回收那些触及不到的堆内存。



## 床单

有次洗衣服时，你把床单也放进去一块洗了洗。因为床单比较长，一个衣架应该晒不开，于是你就用三个衣架分别夹住了床单的头部、中间和尾部，多给它留了一些空间。



【图】



结果等到傍晚收衣服的时候，你还是按照收单件衣服的方式收床单，先是松开一个衣架的夹子，然后把床单拽下来叠起来收好，把那个衣架也拿下来放在一边，接着就去收其它衣服去了。

等到衣服全都收完之后，你抱着衣服和床单走出阳台，关门的时候回头一望：哎？怎么还有两个空衣架在晾衣杆上？我什么时候放上去的？

这两个空衣架叫做**「悬垂指针（Dangling Pointer）」**，它们下面夹的衣服已经被收走，可是仍然被挂在晾衣杆上。

简单来说，这种空衣架是因为收衣服时只收了衣服没收衣架导致的。还有一种情况，如果在晒衣服的时候你只挂上了衣架而没挂衣服，晒完也会有一个孤零零的空衣架挂在晾衣杆上。这种情况下的空衣架被叫做**「野指针（Wild Pointer）」**。



## 代码对照

```cpp
/* C/C++ */

// 这些是晒在晾衣杆上的衣服，它们占据栈内存空间
Cloth cloth1 = Cloth("t-shirt");
Cloth cloth2 = Cloth("jeans");
Cloth cloth3 = Cloth("jacket");

// 这些则是挂在衣架上的衣服，它们占据堆内存空间
Cloth* hanger1 = new Cloth("sweater");
Cloth* hanger2 = new Cloth("pants");
Cloth* hanger3 = new Cloth("socks");

// 使用 `delete` 来拿回晒干的衣服
delete hanger1;   // 拿回晒干的毛衣
delete hanger2;   // 拿回晒干的裤子

// 现在衣架1和衣架2空出来了，你可以把新衣服挂上去
hanger1 = new Cloth("pajamas");
// 也可以把衣架从晾衣杆上拿下来
hanger2 = nullptr;

// 但是如果你忘记拿回衣服，直接把夹子松开拿下衣架，挂着的衣服就会掉到地上
hanger3 = nullptr;  // 衣架3上还晒着袜子呢！
```



```java
/* Java */

// Java 会放竹筐，因此不用担心衣服掉到地上
Cloth hanger1 = new Cloth("sweater");
Cloth hanger2 = new Cloth("pants");
Cloth hanger3 = new Cloth("socks");

// 不用担心！晒干的衣服被 Java 用竹筐接住了
hanger1 = null;
hanger2 = null;
hanger3 = null;
```



```cpp
/* C/C++ */
// 床单很长，需要三个衣架
Cloth* hanger1 = new Cloth("sheet");
Cloth* hanger2 = hanger1;
Cloth* hanger3 = hanger1;

// 记得拿回床单时三个衣架都要拿下来！
delete hanger1;   // 拿回床单
hanger1 = nullptr;
hanger2 = nullptr;

// 是不是忘了什么？衣架3还挂在晾衣杆上呢！
hanger3;	// 无法确定 hanger3 中的值是什么

Cloth* emptyHanger;   // 衣架挂上去但是忘了挂衣服
// 这也会产生值无法确定的 emptyHanger
```

